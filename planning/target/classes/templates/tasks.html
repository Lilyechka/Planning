<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Tasks</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #83a958;
            color: #000000;
            margin: 0;
            padding: 0;
        }
        h1 {
            text-align: center;
            margin-top: 20px;
        }
        div {
            text-align: center;
            margin-bottom: 20px;
        }
        a {
            color: #add285;
            text-decoration: none;
            margin-right: 10px;
        }
        table {
            width: 80%;
            margin: 0 auto;
            border-collapse: collapse;
            border: 1px solid #427322;
        }
        th, td {
            padding: 8px;
            border: 1px solid #427322;
            text-align: left;
        }
        th {
            background-color: #add285;
            color: #000000;
        }
        td {
            background-color: #f2f2f2;
        }
        a {
            color: #0f7c52;
            text-decoration: none;
            margin-right: 10px;
        }
        button {
            background-color: #add285;
            color: #427322;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover {
            background-color: #83a958;
        }
        nav {
            background-color: #83a958;
            padding: 10px;
        }
        .navbar ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
            display: flex;
            justify-content: center;
        }
        .navbar li {
            margin: 0 10px;
        }
    </style>
    </head>
    <body>
    <h1>Tasks</h1>
    <div th:action="@{main/tasks}" method="post" id="taskList"></div>
    <button onclick="showTaskForm()">Create New Task</button>

    <div id="taskForm" style="display:none;">
        <h2 id="formTitle">Create Task</h2>
        <form id="taskFormDetails">
            <input type="hidden" id="taskId">
            <div>
                <label for="topic">Topic:</label>
                <input type="text" id="topic" name="topic" required>
            </div>
            <div>
                <label for="deadline">Deadline:</label>
                <input type="datetime-local" id="deadline" name="deadline" required>
            </div>
            <div>
                <label for="description">Description:</label>
                <textarea id="description" name="description" required></textarea>
            </div>
            <div>
                <button type="submit">Save</button>
                <button type="button" onclick="hideTaskForm()">Cancel</button>
            </div>
        </form>
    </div>
    <table>
        <thead>
        <tr>
            <th>ID</th>
            <th>Title</th>
            <th>Description</th>
            <th>Deadline</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="task : ${tasks}">
            <td th:text="${task.id}"></td>
            <td th:text="${task.title}"></td>
            <td th:text="${task.description}"></td>
            <td th:text="${#dates.format(task.deadline, 'yyyy-MM-dd HH:mm')}"></td>
            <td>
                <!--<a th:href="@{|/tasks/edit/${task.id}|}">Edit</a>-->
                <form th:action="@{|/tasks/edit/${task.id}|}" method="post" style="display:inline;">
                    <button type="submit">Edit</button>
                </form>
                <form th:action="@{|/tasks/delete/${task.id}|}" method="post" style="display:inline;">
                    <button type="submit">Delete</button>
                </form>
            </td>
        </tr>
        </tbody>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script>
        $(document).ready(function() {
            loadTasks();

            $("#taskFormDetails").submit(function(event) {
                event.preventDefault();
                let taskId = $("#taskId").val();
                let url = taskId ? `/main/tasks/${taskId}` : '/main/tasks';
                let method = taskId ? 'PUT' : 'POST';

                $.ajax({
                    type: method,
                    url: url,
                    contentType: 'application/json',
                    data: JSON.stringify({
                        topic: $("#topic").val(),
                        deadline: $("#deadline").val(),
                        description: $("#description").val()
                    }),
                    success: function(response) {
                        loadTasks();
                        hideTaskForm();
                    },
                    error: function(error) {
                        alert("Error saving task: " + error.responseText);
                    }
                });
            });
        });

        function loadTasks() {
            $.get("/main/tasks", function(data) {
                let taskList = "";
                $.each(data, function(index, task) {
                    taskList += `<div>
                    <h3>${task.topic}</h3>
                    <p>Deadline: ${task.deadline}</p>
                    <p>${task.description}</p>
                    <button onclick="editTask(${task.id})">Edit</button>
                    <button onclick="deleteTask(${task.id})">Delete</button>
                </div>`;
                });
                $("#taskList").html(taskList);
            });
        }

        function showTaskForm() {
            $("#formTitle").text("Create Task");
            $("#taskId").val("");
            $("#topic").val("");
            $("#deadline").val("");
            $("#description").val("");
            $("#taskForm").show();
        }

        function hideTaskForm() {
            $("#taskForm").hide();
        }

        function editTask(taskId) {
            $.get(`/main/tasks/${taskId}`, function(task) {
                $("#formTitle").text("Edit Task");
                $("#taskId").val(task.id);
                $("#topic").val(task.topic);
                $("#deadline").val(task.deadline);
                $("#description").val(task.description);
                $("#taskForm").show();
            });
        }

        function deleteTask(taskId) {
            $.ajax({
                type: 'DELETE',
                url: `/main/tasks/${taskId}`,
                success: function(response) {
                    loadTasks();
                },
                error: function(error) {
                    alert("Error deleting task: " + error.responseText);
                }
            });
        }
    </script>
    </table>
    </body>
    </html>
